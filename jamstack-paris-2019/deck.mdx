import { Box, Image, Text, Heading } from "grommet";
import { Appear, Head } from "mdx-deck";
import { Split } from "mdx-deck/layouts";
export { vsDark as theme } from "code-surfer/themes";
import { StatusGood, StatusInfo } from "grommet-icons";
import { TwitterTweetEmbed } from "react-twitter-embed";

import deckTheme, {
  Layout,
  Hero,
  ListItem,
  PointText,
  SlideTitle,
  Command,
  Coder,
  Points
} from "mdx-components";

export const themes = [deckTheme];
const title = "Optimizing heavy image websites in the Gatsby world!";
<Head>
  <title>{title}</title>
  <link
    href="https://fonts.googleapis.com/css?family=Montserrat&display=swap"
    rel="stylesheet"
  />
</Head>;

<Hero conference="JAMstack Paris 2019" title={title} />

---

<Layout conference="JAMstack Paris 2019">
  <Box pad={{ top: "medium" }} gap="small">
    <Box margin={{ vertical: "medium" }} height="50%">
      <Image
        margin="medium"
        fit="contain"
        src={require("file-loader!./images/me.png")}
      />
    </Box>
    <Appear>
      <PointText>Full stack developer @ Sysdream</PointText>
      <PointText>Excited about GraphQL Gatsby and React</PointText>
      <PointText>
        Enjoy travelling and taking pictures (spoiler alert, lots of pictures)
      </PointText>
      <PointText color="brand">Twitter / Github @oorestisime</PointText>
      <PointText color="brand">
        https://jamstack-paris-oorestisime.netlify.com/
      </PointText>
    </Appear>
  </Box>
</Layout>

---

<Layout conference="JAMstack Paris 2019">
  <SlideTitle title="Quick introduction on Gatsby" />
</Layout>

---

<Layout conference="JAMstack Paris 2019">
  <Box pad={{ top: "large" }} gap="medium">
    <Image fit="contain" src={require("file-loader!./images/workflow.png")} />
  </Box>
  <Appear>
    <PointText>Pull in source plugins</PointText>
    <PointText>Write some markdown (or mdx)</PointText>
    <PointText>Use awesome gatsby image</PointText>
    <PointText>Deploy to CDN</PointText>
  </Appear>
</Layout>

---

<Layout conference="JAMstack Paris 2019">
  <SlideTitle title="Everything works great ..... Until you hit the Netlify time builds!" />
  <Box pad={{ top: "medium" }} gap="medium">
    <Appear>
      <PointText>
        And this is the narrative behind beating the damn timeout!
      </PointText>
      <PointText>The different solutions</PointText>
      <PointText>And the lessons learnt</PointText>
    </Appear>
  </Box>
</Layout>

---

<Layout conference="JAMstack Paris 2019">
  <SlideTitle title="The use case" />
  <Appear>
    <Box direction="row" margin={{ horizontal: "xlarge", bottom: "medium" }}>
      <Box basis="2/3">
        <Heading alignSelf="start" margin="none" level="2">
          oasome.blog
        </Heading>
        <Box margin={{ top: "large", left: "medium" }} gap="small">
          <ListItem
            withIcon
            alignSelf="start"
            text="Travel blog with infrequent updates"
          />
          <ListItem
            withIcon
            alignSelf="start"
            text="Average of 10 pictures per blog post"
          />
          <ListItem
            withIcon
            alignSelf="start"
            text="Pictures edited and exported to a 1-2mb size"
          />
          <ListItem
            withIcon
            alignSelf="start"
            text="
            Running gatsby-image for the blur-up effect and
            resizing features.
          "
          />
          <ListItem
            withIcon
            alignSelf="start"
            text="Don't spend money over a side-project"
          />
        </Box>
      </Box>
      <Box basis="1/3">
        <Heading alignSelf="start" margin="none" level="2">
          Initial state
        </Heading>
        <Box margin={{ top: "large", left: "medium" }} gap="small">
          <ListItem
            withIcon
            icon={<StatusGood />}
            alignSelf="start"
            text="4 articles up and running"
          />
          <ListItem
            icon={<StatusGood />}
            withIcon
            alignSelf="start"
            text="Build at 5 minutes"
          />
          <ListItem
            icon={<StatusGood />}
            withIcon
            alignSelf="start"
            text="Wasn't worried about time limit"
          />
          <ListItem
            icon={<StatusGood />}
            withIcon
            alignSelf="start"
            text="Gatsby develop wasn't slow due to cache"
          />
        </Box>
      </Box>
    </Box>
    <Heading alignSelf="center" level="1">
      And then I published another 2 articles
    </Heading>
  </Appear>
</Layout>

---

<Layout conference="JAMstack Paris 2019">
  <SlideTitle title="Solution 1: leveraging the Netlify cache" />
  <PointText size="xlarge">
    What if we leverage the gatsby cache in Netlify?
  </PointText>
  <Command code="npm install gatsby-plugin-netlify-cache" />
  <Box gap="medium" margin={{ top: "medium" }}>
    <ListItem
      size="large"
      withIcon
      Icon={<StatusGood />}
      text="Worked for several months"
    />
    <ListItem
      size="large"
      withIcon
      icon={<StatusInfo color="status-warning" />}
      text="Cache free rebuilds were painfully slow and inconsistent"
    />
    <ListItem
      size="large"
      withIcon
      icon={<StatusInfo color="status-warning" />}
      text="Plugin explodes Netlify caching storage"
    />
  </Box>
</Layout>

---

<Layout conference="JAMstack Paris 2019">
  <SlideTitle title="Solution 2: building on a CI" />
  <PointText size="xlarge">
    What if we build on a CI and then push to netlify?
  </PointText>
  <Command code="npm install netlify-cli" />
  <Box gap="medium" margin={{ top: "medium" }}>
    <ListItem
      size="large"
      text="Promising solution since CircleCI doesn't have a time limit (as long as there is output)"
    />
    <ListItem
      size="large"
      text="Avoid using the harmful netlify cache package"
    />
    <ListItem
      withIcon
      size="large"
      icon={<StatusInfo color="status-warning" />}
      text="CircleCI OOM due to image processing"
    />
  </Box>
</Layout>

---

<Layout conference="JAMstack Paris 2019">
  <SlideTitle title="Solution 3: pre-optimize images" />
  <Box gap="medium">
    <ListItem size="large" text="What about image quality?" />
    <ListItem size="large" text="How much time would we really gain?" />
    <ListItem size="large" text="How do we calculate the correct image size?" />
    <Box alignSelf="center">
      <TwitterTweetEmbed tweetId={"1096433363261579264"} />
    </Box>
  </Box>
</Layout>

---

<Layout conference="JAMstack Paris 2019">
  <SlideTitle title="But how do we calculate the necessary image dimensions?" />
  <Points
    data={[
      "By default gatsby generates x2 x4 /2 /4 dimensions",
      "Calculate image container width and resize image to that width",
      "Ask gatsby to generate / 2 / 4 and x 2"
    ]}
  />
</Layout>

---

<Layout conference="JAMstack Paris 2019">
  <SlideTitle title="Final solution = solution 2 + solution 3" />
  <Box gap="medium">
    <ListItem withIcon icon={<StatusGood size="large" />}>
      <Text>Blog directory size reduced from 196MB to </Text>
      <Text color="brand">70MB</Text>
    </ListItem>
    <ListItem withIcon icon={<StatusGood size="large" />}>
      <Text>CircleCI builds and published new version in </Text>
      <Text color="brand">roughly 5 minutes </Text>
    </ListItem>
    <ListItem
      withIcon
      icon={<StatusGood size="large" />}
      text="No need to cache in between builds"
    />
    <ListItem withIcon icon={<StatusGood size="large" />}>
      <Text>Scales for up to </Text>
      <Text color="brand">180 builds per month</Text>
    </ListItem>
    <ListItem
      withIcon
      icon={<StatusGood size="large" />}
      text="Scales for up to 50 builds per month on a 4x bigger project"
    />
  </Box>
</Layout>

---

<Layout conference="JAMstack Paris 2019">
  <Coder
    data={[
      {
        title: "Here is the image optimizer",
        lang: "js",
        code: require("!!raw-loader!./snippets/optimizer.js").default
      },
      {
        lang: "js",
        focus: "14:28",
        code: require("!!raw-loader!./snippets/optimizer.js").default
      }
    ]}
  />
</Layout>

---

<Layout conference="JAMstack Paris 2019">
  <Coder
    data={[
      {
        title: "CircleCI config.yml",
        lang: "yaml",
        code: require(`!!raw-loader!./snippets/config.yml`).default
      },
      {
        title: "Building gatsby",
        lang: "yaml",
        focus: "7:22",
        code: require(`!!raw-loader!./snippets/config.yml`).default
      },
      {
        title: "Deploying to Netlify",
        lang: "yaml",
        focus: "38:53",
        code: require(`!!raw-loader!./snippets/config.yml`).default
      }
    ]}
  />
</Layout>

---

<Layout conference="JAMstack Paris 2019">
  <SlideTitle title="What's next?" />
  <Points
    data={[
      "Post Netlify preview URL in PR to avoid checking the CircleCI logs",
      "Experiment with keeping original images in github and running the optimize script before gatsby build",
      "Cache in CircleCI gatsby build for even better speed"
    ]}
  />
</Layout>

---

<Layout conference="JAMstack Paris 2019">
  <SlideTitle title="Questions?" />
  <PointText size="xlarge">This presentation wouldn't exist without</PointText>
  <Points
    margin={{ top: "large" }}
    alignSelf="center"
    direction="row"
    data={["Gatsby", "Netlify", "CircleCi"]}
  />
  <Points
    alignSelf="center"
    direction="row"
    data={["mdx-deck", "Grommet", "Code surfer"]}
  />
</Layout>
