import { Box, Image, Text, Heading } from "grommet";
import { Head } from "mdx-deck";
import { Split } from "mdx-deck/layouts";
export { vsDark as theme } from "code-surfer/themes";
import {
  StatusGood,
  StatusInfo,
  Like,
  Dislike,
  InProgress,
  Emoji,
  Group,
  StatusUnknown,
  Configure,
  Technology,
  Launch,
  Cut,
  Image as ImageIcon,
  Aggregate,
  CircleQuestion
} from "grommet-icons";
import { TwitterTweetEmbed } from "react-twitter-embed";

import deckTheme, {
  Layout,
  Hero,
  ListItem,
  PointText,
  SlideTitle,
  Command,
  Coder,
  Points
} from "mdx-components";

export const themes = [deckTheme];
const title = "Optimizing image-heavy websites in the Gatsby world!";
<Head>
  <title>{title}</title>
  <link
    href="https://fonts.googleapis.com/css?family=Montserrat&display=swap"
    rel="stylesheet"
  />
</Head>;

<Hero conference="JAMstack Paris 2019" title={title} />

---

<Layout conference="JAMstack Paris 2019">
  <Image
    margin="medium"
    fit="contain"
    src={require("file-loader!./images/me.png")}
  />
  <PointText margin="small">Full stack developer @ Sysdream</PointText>
  <PointText margin="small">Excited about GraphQL Gatsby and React</PointText>
  <PointText margin="small">
    Enjoy travelling and taking pictures (spoiler alert, lots of pictures)
  </PointText>
  <PointText margin="small" color="brand">
    Twitter / Github @oorestisime
  </PointText>
  <PointText margin="small" color="brand">
    https://jamstack-paris-oorestisime.netlify.com/
  </PointText>
</Layout>

---

<Layout conference="JAMstack Paris 2019" title="Quick introduction on Gatsby">
  <Image fit="contain" src={require("file-loader!./images/schema.png")} />
  <PointText size="xlarge" margin="xsmall">
    Pull in source plugins
  </PointText>
  <PointText size="xlarge" margin="xsmall">
    Write some markdown (or mdx)
  </PointText>
  <PointText size="xlarge" margin="xsmall">
    Use awesome gatsby image
  </PointText>
  <PointText size="xlarge" margin="xsmall">
    Deploy to CDN
  </PointText>
</Layout>

---

<Layout conference="JAMstack Paris 2019" title="Gatsby image">
  <ListItem withIcon Icon={Cut} text="Resize images" />
  <ListItem
    withIcon
    Icon={Aggregate}
    text="Use intersection observer to load images"
  />
  <ListItem withIcon Icon={ImageIcon} text="Blur-up or traced-svg effects" />
  <ListItem
    withIcon
    Icon={Technology}
    text="Great UX due to simplicity and configuration"
  />
</Layout>

---

<Layout conference="JAMstack Paris 2019" title="The use case">
  <ListItem withIcon text="Travel blog with infrequent updates" />
  <ListItem withIcon text="Average of 10 pictures per blog post" />
  <ListItem withIcon text="Pictures edited and exported to a 1-2Mb size" />
  <ListItem
    withIcon
    text="Running gatsby-image for the blur-up effect and resizing features."
  />
  <ListItem withIcon text="Don't spend money over a side-project" />
</Layout>

---

<Layout conference="JAMstack Paris 2019" title="The use case">
  <ListItem withIcon Icon={StatusGood} text="4 articles up and running" />
  <ListItem Icon={StatusGood} withIcon text="Build at 5 minutes" />
  <ListItem Icon={StatusGood} withIcon text="Wasn't worried about time limit" />
  <ListItem
    Icon={StatusGood}
    withIcon
    text="Gatsby develop wasn't slow due to cache"
  />
</Layout>

---

<Layout
  conference="JAMstack Paris 2019"
  title="What if we leverage the gatsby cache?"
>
  <ListItem
    withIcon
    Icon={CircleQuestion}
    text="Maybe we should use the gatsby cache to improve builds"
  />
  <Command code="npm install gatsby-plugin-netlify-cache" />
  <ListItem
    withIcon
    Icon={Like}
    iconColor="status-ok"
    text="Worked for several months"
  />
  <ListItem
    withIcon
    Icon={Dislike}
    iconColor="status-warning"
    text="Cache free rebuilds were painfully slow and then impossible"
  />
  <ListItem
    withIcon
    Icon={Dislike}
    iconColor="status-warning"
    text="Plugin explodes Netlify caching storage (#15)"
  />
</Layout>

---

<Layout
  conference="JAMstack Paris 2019"
  title="What if we had infinite time builds?"
>
  <ListItem
    withIcon
    Icon={InProgress}
    text="If the issue is time then let's find something without time limits!"
  />
  <Command code="npm install netlify-cli" />
  <ListItem
    withIcon
    Icon={Emoji}
    text="Promising solution since CircleCI doesn't have a time limit"
  />
  <ListItem
    withIcon
    Icon={Like}
    iconColor="status-ok"
    text="Avoid using the harmful netlify cache package"
  />
  <ListItem
    withIcon
    Icon={Dislike}
    iconColor="status-warning"
    text="CircleCI out of memory due to image processing"
  />
</Layout>

---

<Layout
  conference="JAMstack Paris 2019"
  title="Experiment: pre-optimize images"
>
  <ListItem
    iconColor="status-ok"
    withIcon
    Icon={Group}
    text="When in doubt ask the community!"
  />
  <ListItem
    withIcon
    text="Reduce image width and height to avoid out of memory"
  />
  <ListItem withIcon Icon={StatusUnknown} text="What about image quality?" />
  <ListItem
    withIcon
    Icon={StatusUnknown}
    text="How much time would we really gain?"
  />
  <ListItem
    withIcon
    Icon={StatusUnknown}
    text="How do we calculate the correct image size?"
  />
</Layout>

---

<Layout
  conference="JAMstack Paris 2019"
  title="But how do we calculate the necessary image dimensions?"
>
  <Coder
    data={[
      {
        lang: "js",
        code: require(`!!raw-loader!./snippets/gatsby-image.js`).default
      }
    ]}
  />
</Layout>

---

<Layout
  conference="JAMstack Paris 2019"
  title="But how do we calculate the necessary image dimensions?"
>
  <Points
    data={[
      "By default gatsby generates x2 x1.5 /2 /4 dimensions",
      "We should calculate the max image width and resize image to that width",
      "Specify the exact sizes we need"
    ]}
  />
</Layout>

---

<Layout
  conference="JAMstack Paris 2019"
  title="What if we combine idea 2 and our experiment?"
>
  <ListItem iconColor="status-ok" withIcon Icon={StatusGood}>
    <Text size="xlarge">CircleCI builds and published new version in </Text>
    <Text size="xlarge" color="brand">
      roughly 5 minutes{" "}
    </Text>
  </ListItem>
  <ListItem
    withIcon
    Icon={StatusGood}
    iconColor="status-ok"
    text="No need to cache in between builds for now"
  />
  <ListItem iconColor="status-ok" withIcon Icon={StatusGood}>
    <Text size="xlarge">Blog directory size reduced from 196Mb to </Text>
    <Text size="xlarge" color="brand">
      70Mb
    </Text>
  </ListItem>
  <ListItem iconColor="status-ok" withIcon Icon={StatusGood}>
    <Text size="xlarge">Scales for up to </Text>
    <Text size="xlarge" color="brand">
      180 builds per month
    </Text>
  </ListItem>
</Layout>

---

<Layout conference="JAMstack Paris 2019">
  <Coder
    data={[
      {
        lang: "js",
        focus: "14:28",
        code: require("!!raw-loader!./snippets/optimizer.js").default
      },
      {
        lang: "js",
        focus: "14:16",
        code: require("!!raw-loader!./snippets/optimizer.js").default
      },
      {
        lang: "js",
        focus: "23:26",
        code: require("!!raw-loader!./snippets/optimizer.js").default
      }
    ]}
  />
</Layout>

---

<Layout conference="JAMstack Paris 2019">
  <Coder
    data={[
      {
        title: "Building gatsby",
        lang: "yaml",
        focus: "7:22",
        code: require(`!!raw-loader!./snippets/config.yml`).default
      },
      {
        title: "Deploying to Netlify",
        lang: "yaml",
        focus: "38:53",
        code: require(`!!raw-loader!./snippets/config.yml`).default
      }
    ]}
  />
</Layout>

---

<Layout conference="JAMstack Paris 2019" title="What's next?">
  <ListItem
    withIcon
    Icon={Technology}
    size="xlarge"
    text="Improve DX: publish netlify preview URL in github"
  />
  <ListItem
    withIcon
    Icon={Configure}
    size="xlarge"
    text="Avoid extra work: keep original images in github and run the optimize script during build"
  />
  <ListItem
    withIcon
    Icon={Launch}
    size="xlarge"
    text="Moar speed: store gatsby cache in CircleCI"
  />
</Layout>

---

<Layout conference="JAMstack Paris 2019" title="Questions?">
  <PointText size="xxlarge">This presentation wouldn't exist without</PointText>
  <Points
    margin={{ vertical: "small" }}
    alignSelf="center"
    direction="row"
    data={["Gatsby", "Netlify", "CircleCi"]}
  />
  <Points
    alignSelf="center"
    textProps={{
      margin: "xsmall",
      size: "large"
    }}
    data={[
      "mdx-deck (web based presentations with markdown and react)",
      "Grommet (React UI components)",
      "Code surfer (Surfing around code in style)"
    ]}
  />
</Layout>
